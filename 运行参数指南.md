# PyTorch UNet é¡¹ç›®è¿è¡Œå‚æ•°æŒ‡å—

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [è®­ç»ƒå‚æ•°](#è®­ç»ƒå‚æ•°)
- [é¢„æµ‹å‚æ•°](#é¢„æµ‹å‚æ•°)
- [ç¡¬ä»¶é…ç½®æ¨è](#ç¡¬ä»¶é…ç½®æ¨è)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯åŸºäºPyTorchå®ç°çš„U-Netå›¾åƒåˆ†å‰²æ¨¡å‹ï¼Œä¸“é—¨ç”¨äºåŒ»å­¦å›¾åƒåˆ†å‰²ã€å«æ˜Ÿå›¾åƒåˆ†å‰²ç­‰ä»»åŠ¡ã€‚æ”¯æŒå¤šç§è®­ç»ƒé…ç½®å’Œä¼˜åŒ–ç­–ç•¥ã€‚

### ä¸»è¦ç‰¹æ€§
- âœ… æ”¯æŒäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»åˆ†å‰²ä»»åŠ¡
- âœ… è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆAMPï¼‰åŠ é€Ÿ
- âœ… WandBå®éªŒè·Ÿè¸ªå’Œå¯è§†åŒ–
- âœ… è‡ªåŠ¨æ£€æŸ¥ç‚¹ä¿å­˜å’Œæ¢å¤
- âœ… æ¢¯åº¦è£å‰ªå’Œå­¦ä¹ ç‡è°ƒåº¦
- âœ… æ˜¾å­˜ä¼˜åŒ–å’Œå¼‚å¸¸å¤„ç†

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### ä¾èµ–å®‰è£…
```bash
pip install -r requirements.txt
```

### ä¸»è¦ä¾èµ–ç‰ˆæœ¬
- `torch==2.0.0`
- `torchvision==0.15.0`
- `numpy==1.24.3`
- `matplotlib==3.7.5`
- `Pillow==10.3.0`
- `tqdm==4.66.4`

## ğŸš€ è®­ç»ƒå‚æ•°è¯¦è§£

### åŸºç¡€è®­ç»ƒå‚æ•°

| å‚æ•° | çŸ­å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|--------|------|
| `--epochs` | `-e` | int | 5 | è®­ç»ƒè½®æ•° |
| `--batch-size` | `-b` | int | 1 | æ¯æ‰¹æ¬¡æ ·æœ¬æ•° |
| `--learning-rate` | `-l` | float | 1e-5 | åˆå§‹å­¦ä¹ ç‡ |
| `--load` | `-f` | str | False | é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ |
| `--scale` | `-s` | float | 0.5 | å›¾åƒç¼©æ”¾å› å­(0-1) |
| `--validation` | `-v` | float | 10.0 | éªŒè¯é›†æ¯”ä¾‹(0-100) |
| `--classes` | `-c` | int | 2 | åˆ†å‰²ç±»åˆ«æ•° |

### ä¼˜åŒ–å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--amp` | bool | False | å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ |
| `--bilinear` | bool | False | ä½¿ç”¨åŒçº¿æ€§æ’å€¼ä¸Šé‡‡æ · |

### å‚æ•°æ¨èå€¼

#### ğŸ“Š è®­ç»ƒè½®æ•° (epochs)
```bash
# å°æ•°æ®é›†ï¼š50-100è½®
--epochs 80

# å¤§æ•°æ®é›†ï¼š20-50è½®  
--epochs 30
```

#### ğŸ“¦ æ‰¹æ¬¡å¤§å° (batch-size)
```bash
# æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´
8GBæ˜¾å­˜:  --batch-size 4-8
16GBæ˜¾å­˜: --batch-size 8-16
32GBæ˜¾å­˜: --batch-size 16-32
```

#### ğŸ¯ å­¦ä¹ ç‡ (learning-rate)
```bash
# æ¨èèŒƒå›´ï¼š1e-4 åˆ° 1e-6
--learning-rate 1e-4    # æ ‡å‡†å­¦ä¹ ç‡
--learning-rate 5e-5    # ä¿å®ˆå­¦ä¹ ç‡
--learning-rate 1e-5    # ç²¾ç»†è°ƒä¼˜
```

#### ğŸ–¼ï¸ å›¾åƒç¼©æ”¾ (scale)
```bash
--scale 1.0    # åŸå§‹å°ºå¯¸ï¼Œæœ€ä½³ç²¾åº¦ï¼Œéœ€è¦æ›´å¤šæ˜¾å­˜
--scale 0.75   # å¹³è¡¡æ€§èƒ½å’Œç²¾åº¦
--scale 0.5    # é»˜è®¤å€¼ï¼ŒèŠ‚çœæ˜¾å­˜
--scale 0.25   # æœ€å°æ˜¾å­˜å ç”¨
```

#### âœ… éªŒè¯é›†æ¯”ä¾‹ (validation)
```bash
--validation 10    # å¤§æ•°æ®é›†æ¨è
--validation 20    # ä¸­ç­‰æ•°æ®é›†æ¨è  
--validation 30    # å°æ•°æ®é›†æ¨è
```

## ğŸ¯ é¢„æµ‹å‚æ•°è¯¦è§£

### åŸºæœ¬è¯­æ³•
```bash
python predict.py [å‚æ•°é€‰é¡¹]
```

### é¢„æµ‹å‚æ•°è¡¨

| å‚æ•° | çŸ­å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|--------|------|
| `--model` | `-m` | str | MODEL.pth | æ¨¡å‹æ–‡ä»¶è·¯å¾„ |
| `--input` | `-i` | str | å¿…éœ€ | è¾“å…¥å›¾ç‰‡è·¯å¾„ |
| `--output` | `-o` | str | è‡ªåŠ¨ç”Ÿæˆ | è¾“å‡ºå›¾ç‰‡è·¯å¾„ |
| `--scale` | `-s` | float | 0.5 | å›¾åƒç¼©æ”¾å› å­ |
| `--mask-threshold` | `-t` | float | 0.5 | æ©ç äºŒå€¼åŒ–é˜ˆå€¼ |
| `--classes` | `-c` | int | 2 | åˆ†å‰²ç±»åˆ«æ•° |
| `--bilinear` | - | bool | False | ä½¿ç”¨åŒçº¿æ€§ä¸Šé‡‡æ · |
| `--viz` | `-v` | bool | False | å¯è§†åŒ–ç»“æœ |
| `--no-save` | `-n` | bool | False | ä¸ä¿å­˜è¾“å‡ºæ©ç  |

## ğŸ’» ç¡¬ä»¶é…ç½®æ¨è

### GPUé…ç½®æ–¹æ¡ˆ

#### ğŸŸ¢ å…¥é—¨çº§é…ç½® (4-6GBæ˜¾å­˜)
```bash
python train.py \
    --epochs 50 \
    --batch-size 2 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.25 \
    --bilinear
```

#### ğŸŸ¡ ä¸»æµé…ç½® (8-12GBæ˜¾å­˜)
```bash
python train.py \
    --epochs 80 \
    --batch-size 8 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.5
```

#### ğŸ”´ é«˜ç«¯é…ç½® (16GB+æ˜¾å­˜)
```bash
python train.py \
    --epochs 100 \
    --batch-size 16 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.75
```

#### âšª CPUè®­ç»ƒ
```bash
python train.py \
    --epochs 30 \
    --batch-size 1 \
    --learning-rate 1e-4
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€è®­ç»ƒç¤ºä¾‹

#### 1. å¿«é€Ÿå¼€å§‹è®­ç»ƒ
```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°è¿›è¡Œè®­ç»ƒ
python train.py

# åŸºç¡€è‡ªå®šä¹‰è®­ç»ƒ
python train.py --epochs 50 --batch-size 8 --learning-rate 1e-4
```

#### 2. é«˜æ€§èƒ½è®­ç»ƒ
```bash
# æ··åˆç²¾åº¦ + å¤§æ‰¹æ¬¡è®­ç»ƒ
python train.py \
    --epochs 100 \
    --batch-size 16 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.75 \
    --validation 20
```

#### 3. ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
```bash
# ä»æŒ‡å®šæ£€æŸ¥ç‚¹æ¢å¤
python train.py \
    --load checkpoints/checkpoint_epoch10.pth \
    --epochs 50 \
    --batch-size 8
```

#### 4. å¤šåˆ†ç±»åˆ†å‰²ä»»åŠ¡
```bash
# 5åˆ†ç±»åˆ†å‰²ä»»åŠ¡
python train.py \
    --classes 5 \
    --epochs 80 \
    --batch-size 4 \
    --learning-rate 1e-4 \
    --amp
```

### é¢„æµ‹ç¤ºä¾‹

#### 1. å•å¼ å›¾ç‰‡é¢„æµ‹
```bash
python predict.py \
    --model checkpoints/checkpoint_epoch50.pth \
    --input test_image.jpg \
    --output result.png
```

#### 2. æ‰¹é‡é¢„æµ‹ï¼ˆå¯è§†åŒ–ï¼‰
```bash
python predict.py \
    --model checkpoints/best_model.pth \
    --input image1.jpg image2.jpg image3.jpg \
    --viz \
    --no-save
```

#### 3. è‡ªå®šä¹‰å‚æ•°é¢„æµ‹
```bash
python predict.py \
    --model best_model.pth \
    --input test.jpg \
    --output result.png \
    --scale 0.75 \
    --mask-threshold 0.3 \
    --classes 3
```

### ç‰¹å®šä»»åŠ¡é…ç½®

#### ğŸ¥ åŒ»å­¦å›¾åƒåˆ†å‰²
```bash
python train.py \
    --epochs 80 \
    --batch-size 4 \
    --learning-rate 1e-4 \
    --amp \
    --validation 20 \
    --scale 0.5
```

#### ğŸ›°ï¸ å«æ˜Ÿå›¾åƒåˆ†å‰²
```bash
python train.py \
    --epochs 60 \
    --batch-size 8 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.75 \
    --validation 15
```

#### ğŸ”¬ ç”Ÿç‰©å›¾åƒåˆ†æ
```bash
python train.py \
    --epochs 100 \
    --batch-size 4 \
    --learning-rate 1e-5 \
    --amp \
    --validation 15 \
    --scale 0.5
```

## âš ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### ğŸš¨ æ˜¾å­˜ä¸è¶³ (CUDA Out of Memory)

**é—®é¢˜ç—‡çŠ¶ï¼š**
```
RuntimeError: CUDA out of memory
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ–¹æ¡ˆ1ï¼šå¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
python train.py --amp

# æ–¹æ¡ˆ2ï¼šå‡å°æ‰¹æ¬¡å¤§å°
python train.py --batch-size 1

# æ–¹æ¡ˆ3ï¼šé™ä½å›¾åƒåˆ†è¾¨ç‡
python train.py --scale 0.25

# æ–¹æ¡ˆ4ï¼šä½¿ç”¨åŒçº¿æ€§æ’å€¼å‡å°‘å‚æ•°é‡
python train.py --bilinear

# æ–¹æ¡ˆ5ï¼šç»„åˆä¼˜åŒ–ï¼ˆæ¨èï¼‰
python train.py --amp --batch-size 2 --scale 0.25 --bilinear
```

#### ğŸ” è®­ç»ƒä¸æ”¶æ•›

**å¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š**

1. **å­¦ä¹ ç‡è¿‡é«˜**
```bash
# é™ä½å­¦ä¹ ç‡
python train.py --learning-rate 1e-5
```

2. **æ‰¹æ¬¡å¤§å°è¿‡å°**
```bash
# å¢åŠ æ‰¹æ¬¡å¤§å°ï¼ˆåœ¨æ˜¾å­˜å…è®¸çš„æƒ…å†µä¸‹ï¼‰
python train.py --batch-size 8
```

3. **æ•°æ®ä¸è¶³**
```bash
# å¢åŠ éªŒè¯é›†æ¯”ä¾‹ï¼Œç¡®ä¿æ•°æ®åˆ’åˆ†åˆç†
python train.py --validation 20
```

#### ğŸ“‰ éªŒè¯åˆ†æ•°ä½

**ä¼˜åŒ–ç­–ç•¥ï¼š**
```bash
# 1. å¢åŠ è®­ç»ƒè½®æ•°
python train.py --epochs 100

# 2. è°ƒé«˜å›¾åƒåˆ†è¾¨ç‡
python train.py --scale 0.75

# 3. è°ƒæ•´å­¦ä¹ ç‡
python train.py --learning-rate 5e-5
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### ğŸš€ è®­ç»ƒåŠ é€Ÿ
```bash
# å¯ç”¨æ‰€æœ‰ä¼˜åŒ–é€‰é¡¹
python train.py \
    --amp \
    --batch-size 16 \
    --scale 0.75 \
    --epochs 80
```

#### ğŸ’¾ æ˜¾å­˜ä¼˜åŒ–
```bash
# æé™æ˜¾å­˜ä¼˜åŒ–
python train.py \
    --amp \
    --bilinear \
    --batch-size 1 \
    --scale 0.25
```

### ç›‘æ§å’Œè°ƒè¯•

#### ğŸ“Š WandBç›‘æ§
é¡¹ç›®å·²é›†æˆWandBï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ï¼š
- è®°å½•è®­ç»ƒå’ŒéªŒè¯æŸå¤±
- å¯è§†åŒ–æƒé‡å’Œæ¢¯åº¦åˆ†å¸ƒ
- æ˜¾ç¤ºé¢„æµ‹ç»“æœå¯¹æ¯”
- è·Ÿè¸ªå­¦ä¹ ç‡å˜åŒ–

#### ğŸ”§ æ—¥å¿—å’Œæ£€æŸ¥ç‚¹
- è®­ç»ƒæ—¥å¿—ï¼šå®æ—¶æ˜¾ç¤ºè®­ç»ƒè¿›åº¦
- æ£€æŸ¥ç‚¹ä¿å­˜ï¼š`checkpoints/checkpoint_epoch{N}.pth`
- è‡ªåŠ¨æ¢å¤ï¼šæ”¯æŒä»ä»»æ„æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ

## ğŸ“š å‚æ•°é€‰æ‹©æŒ‡å—

### æ ¹æ®æ•°æ®é›†å¤§å°é€‰æ‹©å‚æ•°

#### å°æ•°æ®é›† (< 1000å¼ )
```bash
python train.py \
    --epochs 100 \
    --batch-size 4 \
    --learning-rate 1e-4 \
    --validation 30
```

#### ä¸­ç­‰æ•°æ®é›† (1000-10000å¼ )
```bash
python train.py \
    --epochs 80 \
    --batch-size 8 \
    --learning-rate 1e-4 \
    --validation 20
```

#### å¤§æ•°æ®é›† (> 10000å¼ )
```bash
python train.py \
    --epochs 50 \
    --batch-size 16 \
    --learning-rate 1e-4 \
    --validation 10
```

### æ ¹æ®ä»»åŠ¡ç±»å‹è°ƒæ•´å‚æ•°

#### ç²¾ç»†åˆ†å‰²ä»»åŠ¡
```bash
python train.py \
    --scale 0.75 \
    --learning-rate 5e-5 \
    --validation 25
```

#### å¿«é€ŸåŸå‹éªŒè¯
```bash
python train.py \
    --epochs 20 \
    --batch-size 8 \
    --scale 0.25 \
    --amp
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®è·¯å¾„æ˜¯å¦æ­£ç¡® (`data/imgs/` å’Œ `data/masks/`)
2. GPUé©±åŠ¨å’ŒCUDAç‰ˆæœ¬æ˜¯å¦å…¼å®¹
3. ä¾èµ–åŒ…ç‰ˆæœ¬æ˜¯å¦åŒ¹é…
4. æŸ¥çœ‹è®­ç»ƒæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

**ç¥æ‚¨è®­ç»ƒé¡ºåˆ©ï¼** ğŸ‰
