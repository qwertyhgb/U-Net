# PyTorch UNet 项目运行参数指南

## 📋 目录
- [项目概述](#项目概述)
- [环境要求](#环境要求)
- [训练参数](#训练参数)
- [预测参数](#预测参数)
- [硬件配置推荐](#硬件配置推荐)
- [使用示例](#使用示例)
- [故障排除](#故障排除)

## 🎯 项目概述

本项目是基于PyTorch实现的U-Net图像分割模型，专门用于医学图像分割、卫星图像分割等任务。支持多种训练配置和优化策略。

### 主要特性
- ✅ 支持二分类和多分类分割任务
- ✅ 自动混合精度训练（AMP）加速
- ✅ WandB实验跟踪和可视化
- ✅ 自动检查点保存和恢复
- ✅ 梯度裁剪和学习率调度
- ✅ 显存优化和异常处理

## 🔧 环境要求

### 依赖安装
```bash
pip install -r requirements.txt
```

### 主要依赖版本
- `torch==2.0.0`
- `torchvision==0.15.0`
- `numpy==1.24.3`
- `matplotlib==3.7.5`
- `Pillow==10.3.0`
- `tqdm==4.66.4`

## 🚀 训练参数详解

### 基础训练参数

| 参数 | 短参数 | 类型 | 默认值 | 说明 |
|------|--------|------|--------|------|
| `--epochs` | `-e` | int | 5 | 训练轮数 |
| `--batch-size` | `-b` | int | 1 | 每批次样本数 |
| `--learning-rate` | `-l` | float | 1e-5 | 初始学习率 |
| `--load` | `-f` | str | False | 预训练模型路径 |
| `--scale` | `-s` | float | 0.5 | 图像缩放因子(0-1) |
| `--validation` | `-v` | float | 10.0 | 验证集比例(0-100) |
| `--classes` | `-c` | int | 2 | 分割类别数 |

### 优化参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--amp` | bool | False | 启用混合精度训练 |
| `--bilinear` | bool | False | 使用双线性插值上采样 |

### 参数推荐值

#### 📊 训练轮数 (epochs)
```bash
# 小数据集：50-100轮
--epochs 80

# 大数据集：20-50轮  
--epochs 30
```

#### 📦 批次大小 (batch-size)
```bash
# 根据GPU显存调整
8GB显存:  --batch-size 4-8
16GB显存: --batch-size 8-16
32GB显存: --batch-size 16-32
```

#### 🎯 学习率 (learning-rate)
```bash
# 推荐范围：1e-4 到 1e-6
--learning-rate 1e-4    # 标准学习率
--learning-rate 5e-5    # 保守学习率
--learning-rate 1e-5    # 精细调优
```

#### 🖼️ 图像缩放 (scale)
```bash
--scale 1.0    # 原始尺寸，最佳精度，需要更多显存
--scale 0.75   # 平衡性能和精度
--scale 0.5    # 默认值，节省显存
--scale 0.25   # 最小显存占用
```

#### ✅ 验证集比例 (validation)
```bash
--validation 10    # 大数据集推荐
--validation 20    # 中等数据集推荐  
--validation 30    # 小数据集推荐
```

## 🎯 预测参数详解

### 基本语法
```bash
python predict.py [参数选项]
```

### 预测参数表

| 参数 | 短参数 | 类型 | 默认值 | 说明 |
|------|--------|------|--------|------|
| `--model` | `-m` | str | MODEL.pth | 模型文件路径 |
| `--input` | `-i` | str | 必需 | 输入图片路径 |
| `--output` | `-o` | str | 自动生成 | 输出图片路径 |
| `--scale` | `-s` | float | 0.5 | 图像缩放因子 |
| `--mask-threshold` | `-t` | float | 0.5 | 掩码二值化阈值 |
| `--classes` | `-c` | int | 2 | 分割类别数 |
| `--bilinear` | - | bool | False | 使用双线性上采样 |
| `--viz` | `-v` | bool | False | 可视化结果 |
| `--no-save` | `-n` | bool | False | 不保存输出掩码 |

## 💻 硬件配置推荐

### GPU配置方案

#### 🟢 入门级配置 (4-6GB显存)
```bash
python train.py \
    --epochs 50 \
    --batch-size 2 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.25 \
    --bilinear
```

#### 🟡 主流配置 (8-12GB显存)
```bash
python train.py \
    --epochs 80 \
    --batch-size 8 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.5
```

#### 🔴 高端配置 (16GB+显存)
```bash
python train.py \
    --epochs 100 \
    --batch-size 16 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.75
```

#### ⚪ CPU训练
```bash
python train.py \
    --epochs 30 \
    --batch-size 1 \
    --learning-rate 1e-4
```

## 📝 使用示例

### 基础训练示例

#### 1. 快速开始训练
```bash
# 使用默认参数进行训练
python train.py

# 基础自定义训练
python train.py --epochs 50 --batch-size 8 --learning-rate 1e-4
```

#### 2. 高性能训练
```bash
# 混合精度 + 大批次训练
python train.py \
    --epochs 100 \
    --batch-size 16 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.75 \
    --validation 20
```

#### 3. 从检查点恢复训练
```bash
# 从指定检查点恢复
python train.py \
    --load checkpoints/checkpoint_epoch10.pth \
    --epochs 50 \
    --batch-size 8
```

#### 4. 多分类分割任务
```bash
# 5分类分割任务
python train.py \
    --classes 5 \
    --epochs 80 \
    --batch-size 4 \
    --learning-rate 1e-4 \
    --amp
```

### 预测示例

#### 1. 单张图片预测
```bash
python predict.py \
    --model checkpoints/checkpoint_epoch50.pth \
    --input test_image.jpg \
    --output result.png
```

#### 2. 批量预测（可视化）
```bash
python predict.py \
    --model checkpoints/best_model.pth \
    --input image1.jpg image2.jpg image3.jpg \
    --viz \
    --no-save
```

#### 3. 自定义参数预测
```bash
python predict.py \
    --model best_model.pth \
    --input test.jpg \
    --output result.png \
    --scale 0.75 \
    --mask-threshold 0.3 \
    --classes 3
```

### 特定任务配置

#### 🏥 医学图像分割
```bash
python train.py \
    --epochs 80 \
    --batch-size 4 \
    --learning-rate 1e-4 \
    --amp \
    --validation 20 \
    --scale 0.5
```

#### 🛰️ 卫星图像分割
```bash
python train.py \
    --epochs 60 \
    --batch-size 8 \
    --learning-rate 1e-4 \
    --amp \
    --scale 0.75 \
    --validation 15
```

#### 🔬 生物图像分析
```bash
python train.py \
    --epochs 100 \
    --batch-size 4 \
    --learning-rate 1e-5 \
    --amp \
    --validation 15 \
    --scale 0.5
```

## ⚠️ 故障排除

### 常见问题及解决方案

#### 🚨 显存不足 (CUDA Out of Memory)

**问题症状：**
```
RuntimeError: CUDA out of memory
```

**解决方案：**
```bash
# 方案1：启用混合精度训练
python train.py --amp

# 方案2：减小批次大小
python train.py --batch-size 1

# 方案3：降低图像分辨率
python train.py --scale 0.25

# 方案4：使用双线性插值减少参数量
python train.py --bilinear

# 方案5：组合优化（推荐）
python train.py --amp --batch-size 2 --scale 0.25 --bilinear
```

#### 🔍 训练不收敛

**可能原因和解决方案：**

1. **学习率过高**
```bash
# 降低学习率
python train.py --learning-rate 1e-5
```

2. **批次大小过小**
```bash
# 增加批次大小（在显存允许的情况下）
python train.py --batch-size 8
```

3. **数据不足**
```bash
# 增加验证集比例，确保数据划分合理
python train.py --validation 20
```

#### 📉 验证分数低

**优化策略：**
```bash
# 1. 增加训练轮数
python train.py --epochs 100

# 2. 调高图像分辨率
python train.py --scale 0.75

# 3. 调整学习率
python train.py --learning-rate 5e-5
```

### 性能优化建议

#### 🚀 训练加速
```bash
# 启用所有优化选项
python train.py \
    --amp \
    --batch-size 16 \
    --scale 0.75 \
    --epochs 80
```

#### 💾 显存优化
```bash
# 极限显存优化
python train.py \
    --amp \
    --bilinear \
    --batch-size 1 \
    --scale 0.25
```

### 监控和调试

#### 📊 WandB监控
项目已集成WandB，训练过程中会自动：
- 记录训练和验证损失
- 可视化权重和梯度分布
- 显示预测结果对比
- 跟踪学习率变化

#### 🔧 日志和检查点
- 训练日志：实时显示训练进度
- 检查点保存：`checkpoints/checkpoint_epoch{N}.pth`
- 自动恢复：支持从任意检查点恢复训练

## 📚 参数选择指南

### 根据数据集大小选择参数

#### 小数据集 (< 1000张)
```bash
python train.py \
    --epochs 100 \
    --batch-size 4 \
    --learning-rate 1e-4 \
    --validation 30
```

#### 中等数据集 (1000-10000张)
```bash
python train.py \
    --epochs 80 \
    --batch-size 8 \
    --learning-rate 1e-4 \
    --validation 20
```

#### 大数据集 (> 10000张)
```bash
python train.py \
    --epochs 50 \
    --batch-size 16 \
    --learning-rate 1e-4 \
    --validation 10
```

### 根据任务类型调整参数

#### 精细分割任务
```bash
python train.py \
    --scale 0.75 \
    --learning-rate 5e-5 \
    --validation 25
```

#### 快速原型验证
```bash
python train.py \
    --epochs 20 \
    --batch-size 8 \
    --scale 0.25 \
    --amp
```

---

## 📞 技术支持

如果遇到问题，请检查：
1. 数据路径是否正确 (`data/imgs/` 和 `data/masks/`)
2. GPU驱动和CUDA版本是否兼容
3. 依赖包版本是否匹配
4. 查看训练日志中的错误信息

**祝您训练顺利！** 🎉
